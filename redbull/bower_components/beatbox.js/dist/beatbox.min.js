Beatbox=function(t,e,i){this.playing=!1,this._pattern=t,this._strokeLength=e,this._repeat=i,this._timeout=null,this._timeout2=null,this._players=[],this._position=0,this._referenceTime=null},Beatbox._cacheInterval=1e3,Beatbox._cacheLength=2500,Beatbox._webAudio=Howler.usingWebAudio,Beatbox._instruments={},Beatbox.registerInstrument=function(t,e,i){Beatbox._instruments[t]={soundObj:e,sprite:i}},Beatbox._setTimeout=setTimeout,Beatbox._playWhen=function(t,e,i){Beatbox._whenOverride=e,setTimeout=function(t,i){return Beatbox._setTimeout.call(null,t,i+1e3*(e-Howler.ctx.currentTime))};try{Beatbox._play(t,i)}finally{Beatbox._whenOverride=null,setTimeout=Beatbox._setTimeout}},Beatbox._play=function(t,e){t.instrumentObj.soundObj._volume=t.volume,t.instrumentObj.soundObj.play(t.instrumentObj.sprite,e)},Beatbox._getInstrumentWithParams=function(t){if(null==t)return null;var e={instrumentObj:Beatbox._instruments["string"==typeof t?t:t.instrument],volume:null!=t.volume?t.volume:1};return e.instrumentObj?e:null},Beatbox.prototype.play=function(){this.playing||(this.playing=!0,Beatbox._webAudio?this._playUsingWebAudio():this._playUsingTimeout(),this.onplay&&this.onplay())},Beatbox.prototype.stop=function(){this.playing&&(clearTimeout(this._timeout),this._timeout=null,this._timeout2&&(clearTimeout(this._timeout2),this._timeout2=null),Beatbox._webAudio&&(this._position=this.getPosition(),this._clearWebAudioCache()),this.playing=!1,this.onstop&&this.onstop())},Beatbox.prototype.getPosition=function(){if(Beatbox._webAudio&&this.playing){for(var t=1e3*(Howler.ctx.currentTime-this._referenceTime)/this._strokeLength;0>t;)t+=this._pattern.length;return Math.floor(t)}return this._position},Beatbox.prototype.setPosition=function(t){var e=this.playing;e&&this.stop(),this._position=null!=t?t:0,e&&this.play()},Beatbox.prototype.setPattern=function(t){this._pattern=t,this._applyChanges()},Beatbox.prototype.setBeatLength=function(t){if(Beatbox._webAudio){this._clearWebAudioCache(Howler.ctx.currentTime+1e-6);for(var e=1e3*(Howler.ctx.currentTime-this._referenceTime)/this._strokeLength;0>e;)e+=this._pattern.length;this._referenceTime=Howler.ctx.currentTime-e*t/1e3}this._strokeLength=t,this._applyChanges()},Beatbox.prototype.setRepeat=function(t){this._repeat=t,this._applyChanges()},Beatbox.prototype._applyChanges=function(){if(Beatbox._webAudio&&this.playing){for(this._position=this.getPosition()+1;this._referenceTime>Howler.ctx.currentTime;)this._referenceTime-=this._pattern.length*this._strokeLength/1e3;this._clearWebAudioCache(Howler.ctx.currentTime+1e-6),this._fillWebAudioCache()}},Beatbox.prototype._playUsingTimeout=function(){var t=this;if(this.onbeat&&setTimeout(function(){t.onbeat(t._position)},0),this._pattern[this._position])for(var e=0;e<this._pattern[this._position].length;e++){var i=Beatbox._getInstrumentWithParams(this._pattern[this._position][e]);i&&Beatbox._play(i)}this._timeout=setTimeout(function(){return++t._position>=t._pattern.length&&(t._position=0,!t._repeat)?(t.playing=!1,void(t.onstop&&setTimeout(t.onstop,0))):void t._playUsingTimeout()},this._strokeLength)},Beatbox.prototype._playUsingWebAudio=function(){this._referenceTime=Howler.ctx.currentTime-this._position*this._strokeLength/1e3;var t=this,e=function(){t._fillWebAudioCache()===!1?t._timeout=setTimeout(function(){t.stop(),t._position=0,t.onstop&&t.onstop()},1e3*t._referenceTime+t._strokeLength*t._pattern.length-1e3*Howler.ctx.currentTime):t._timeout=setTimeout(e,Beatbox._cacheInterval)};if(e(),this.onbeat){var i=function(){t.onbeat(t.getPosition());var e=1e3*(Howler.ctx.currentTime-t._referenceTime)%t._strokeLength;0>e&&(e+=t._strokeLength),t._timeout2=setTimeout(i,t._strokeLength-e)};i()}},Beatbox.prototype._fillWebAudioCache=function(){for(var t=this,e=Howler.ctx.currentTime+Beatbox._cacheLength/1e3;this._referenceTime+this._position*this._strokeLength/1e3<=e;){if(this._position>=this._pattern.length){if(!this._repeat)return!1;this._position=0,this._referenceTime=this._referenceTime+this._strokeLength*this._pattern.length/1e3}if(this._pattern[this._position])for(var i=0;i<this._pattern[this._position].length;i++)!function(){var e=Beatbox._getInstrumentWithParams(t._pattern[t._position][i]);if(e){var o=t._referenceTime+t._position*t._strokeLength/1e3;Beatbox._playWhen(e,o,function(i){t._players.push({time:o,instr:e.instrumentObj.soundObj,id:i})})}}();this._position++}},Beatbox.prototype._clearWebAudioCache=function(t){for(var e=0;e<this._players.length;e++)(null==t||this._players[e].time>=t)&&(this._players[e].instr.stop(this._players[e].id),this._players.splice(e,1),e--)},setTimeout(function(){if(Beatbox._webAudio){var t=Howler.ctx.createBufferSource;Howler.ctx.createBufferSource=function(){var e=t.apply(this,arguments),i=e.start;return e.start=function(){return null!=Beatbox._whenOverride&&(arguments[0]=Beatbox._whenOverride),i.apply(this,arguments)},e}}},0),"function"==typeof define&&define.amd&&define(["howler"],function(){return Beatbox}),"undefined"!=typeof module&&(module.exports=Beatbox);